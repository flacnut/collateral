import "reflect-metadata";
import { createConnection, getConnectionOptions } from "typeorm";
import express from "express";
import { ApolloServer } from "apollo-server-express";
import { buildSchema } from "type-graphql";
import DBInit from "./utils/DBInit";
import jwt from "jsonwebtoken";
import cors from "cors";
import bodyParser from "body-parser";
import { PlaidResolver } from "./resolvers";

import crypto from "crypto";

const secret = crypto.randomBytes(64).toString("hex");

export default async function StartServer() {
  const app = express();

  app.use(cors());
  app.use(bodyParser.json());
  app.use(bodyParser.raw());

  app.post("/login", (req, res) => {
    console.dir(req.body);
    const token = jwt.sign(
      { exp: Math.floor(Date.now() / 1000) + 60 * 60, data: req.body.email },
      secret
    );
    res.json({
      accessToken: token,
      user: {
        displayName: "Adam Sheldon",
        photoURL:
          "data:image/png;base64,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",
        role: "Administrator",
      },
    });
  });

  app.get("/api/account/my-account", (_, res) => {
    res.json({
      displayName: "Adam Sheldon",
      photoURL:
        "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAARAAAAD4CAYAAAAkarlOAAAMPWlDQ1BJQ0MgUHJvZmlsZQAASImVVwdYU8kWnluSkJDQAhGQEnoTRKQjJYQWQEA62AhJgFBiCAQVO7Ko4NpFFGzoioiCawFkLYjYXQR7X1BRUdata:image/png;base64,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:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAARAAAAD4CAYAAAAkarlOAAAMPWlDQ1BJQ0MgUHJvZmlsZQAASImVVwdYU8kWnluSkJDQAhGQEnoTRKQjJYQWQEA62AhJgFBiCAQVO7Ko4NpFFGzoioiCawFkLYjYXQR7X1BRUdbFgr28SQFd95XvzffNnf/+c+Y/Z86de+8MAOqtXLE4G9UAIEeUL4kO9mcmJiUzSY8ABRgBKrACJC4vT8yKigoHsAy1fy9vrgFE1l62l2n9s/+/Fk2+II8HABIFcSo/j5cD8QEA8CqeWJIPAFHGm03PF8swrEBbAgOEeLEMpytwlQynKvBeuU1sNBvidgBUqFyuJB0AtU7IMwt46VBDbQBiRxFfKAJAnQmxT07OND7EKRBbQxsxxDJ999TvdNL/ppk6rMnlpg9jxVzkRSVAmCfO5s78P9Pxv0tOtnTIhyWs1AxJSLRszjBvN7KmhckwFeJ+UWpEJMRaEL8T8uX2EKOUDGlInMIeNeDlsWHOAANiRz43IAxiA4iDRNkR4Uo+NU0YxIEYrhB0hjCfEwuxLsSLBXmBMUqbLZJp0UpfaGOahM1S8me4Erlfma970qw4llL/ZYaAo9TH1AozYhMgpkBsXiCMj4BYDWKHvKyYMKXNuMIMdsSQjUQaLYvfHOJogSjYX6GPFaRJgqKV9qU5eUPzxbZkCDkRSrwvPyM2RJEfrJ3HlccP54J1CkSsuCEdQV5i+NBc+IKAQMXcsScCUVyMUuedON8/WjEWp4izo5T2uKkgO1jGm0LsnFcQoxyLx+fDBanQx9PE+VGxijjxwkxuaJQiHnwFCAdsEACYQAprKpgGMoGwo7+pH94peoIAF0hAOhAAeyUzNCJB3iOC1xhQCP6ESADyhsf5y3sFoADyn4dZxdUepMl7C+QjssAjiHNAGMiG91L5KNGwt3jwEDLCf3jnwsqD8WbDKuv/9/wQ+41hQSZcyUiHPDLVhyyJgcQAYggxiGiD6+M+uBceDq9+sDrh7rjH0Dy+2RMeEboI9wlXCd2Em1OFRZIfohwPuqF+kDIXqd/nAreEmi64P+4N1aEyzsD1gT3uDP2wcF/o2QWybGXcsqwwf9D+2wy+expKO7IjGSWPIPuRrX8cqWar5jKsIsv19/lRxJo6nG/2cM+P/tnfZZ8P27AfLbHF2H7sNHYcO4sdxpoAEzuGNWMXsCMyPLy6HspX15C3aHk8WVBH+A9/Q09Wlsk8xzrHPsdPir58wQzZNxqwp4lnSoTpGflMFvwjCJgcEc9hFNPJ0ckJANn/RfH5esWQ/zcQxrlvXG4rAB6lkEz/xnHNADj0CAD6m2+c2Uv42qwA4EgnTyopUHC47EKAXwl1+Kbpwf+XGbCG83ECrsAL+IFAEAoiQSxIAlNg9BlwnUvAdDAbLAAloAysAGvBBrAZbAM7wR6wDzSBw+A4OAXOg05wFdyGq6cXPAMD",
      role: "Administrator",
    });
  });

  const options = await getConnectionOptions(
    process.env.NODE_ENV || "development"
  );

  await createConnection({ ...options, name: "default" });
  await DBInit();

  try {
    const apolloServer = new ApolloServer({
      schema: await buildSchema({
        resolvers: [
          /*AccountResolver,
          SourceResolver,
          TransactionResolver,
          TagResolver,
          FilteredTransactionResolver,*/
          PlaidResolver,
        ],
        validate: true,
      }),
      context: ({ req, res }) => ({ req, res }),
    });

    apolloServer.applyMiddleware({ app, cors: true });
  } catch (err) {
    console.error(err);
    process.exit(1);
  }

  const port = process.env.PORT || 4000;
  app.listen(port, () => {
    console.log(`server started at http://localhost:${port}/graphql`);
  });
}
